name: Int√©gration continue

permissions:
  contents: read

on:
  workflow_dispatch:
  pull_request:
    paths-ignore: ['**.md']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pnpm-install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch deps
        if: ${{ !env.ACT }}
        uses: ./.github/actions/pnpm-install
        with:
          bryntum_access_token: ${{ secrets.BRYNTUM_ACCESS_TOKEN }}

  lint:
    needs: pnpm-install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/pnpm-install
      - name: Generate Nx project graph
        run: pnpm nx show projects
      - name: Lint all projects
        run: pnpm nx run-many -t lint

  typecheck:
    needs: pnpm-install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/pnpm-install
      - name: Type check all projects
        run: pnpm nx run-many -t typecheck --parallel=3

  build:
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/pnpm-install
      - name: Build tools
        run: pnpm nx build tools
      - name: Generate env for site
        uses: ./.github/actions/app-env
        with:
          app_name: backend
          json_vars: ${{ toJSON(vars) }}
          json_secrets: ${{ toJSON(secrets) }}
      - name: Build site
        run: pnpm nx build site
      - name: Build panier
        run: pnpm nx build panier

  init-db:
    needs: [lint, typecheck]
    uses: ./.github/workflows/init-db.yml
    secrets: inherit

  test-api:
    needs: [init-db, lint, typecheck]
    uses: ./.github/workflows/test-api.yml
    secrets: inherit

  test-package-api:
    needs: [init-db, lint, typecheck]
    uses: ./.github/workflows/test-package-api.yml
    secrets: inherit

  test-backend:
    needs: [init-db, lint, typecheck]
    uses: ./.github/workflows/test-backend.yml
    secrets: inherit

  test-db-deploy:
    needs: [init-db, lint, typecheck]
    uses: ./.github/workflows/test-db-deploy.yml
    secrets: inherit

  test-package-ui:
    needs: [lint, typecheck]
    uses: ./.github/workflows/test-package-ui.yml

  test-app:
    needs: [lint, typecheck]
    uses: ./.github/workflows/test-app.yml

  test-e2e:
    needs: [init-db, lint, typecheck]
    uses: ./.github/workflows/test-e2e.yml
    secrets: inherit
